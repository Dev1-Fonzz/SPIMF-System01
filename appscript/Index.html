<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPIMF - Sistem Pengurusan Identiti Membership FareezOnzz</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --gradient-start: #3498db;
            --gradient-end: #2c3e50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Login Card */
        .login-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: none;
        }

        .login-card.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .login-header {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 30px;
            text-align: center;
        }

        .logo {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .system-title {
            font-size: 1.8em;
            font-weight: 300;
        }

        .system-subtitle {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .time-info {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
        }

        .countdown {
            font-size: 1.2em;
            font-weight: bold;
            color: #f1c40f;
            margin-top: 5px;
        }

        .login-body {
            padding: 40px;
        }

        .method-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .method-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: var(--secondary-color);
        }

        .method-card.active {
            background: var(--secondary-color);
            color: white;
        }

        .method-icon {
            font-size: 2.5em;
            margin-bottom: 15px;
        }

        .login-form {
            max-width: 500px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-color);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            border-color: var(--secondary-color);
            outline: none;
        }

        .btn {
            padding: 15px 40px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: var(--secondary-color);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-danger {
            background: var(--accent-color);
            color: white;
        }

        .error-message {
            color: var(--accent-color);
            background: #ffeaea;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: none;
        }

        /* Dashboard */
        .dashboard {
            display: none;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        .dashboard.active {
            display: block;
        }

        .dashboard-header {
            background: linear-gradient(to right, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 25px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .user-welcome {
            flex: 1;
            min-width: 300px;
        }

        .welcome-text {
            font-size: 1.5em;
            margin-bottom: 10px;
        }

        .admin-message {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-style: italic;
        }

        .profile-section {
            text-align: center;
            min-width: 200px;
        }

        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 5px solid white;
            object-fit: cover;
            margin-bottom: 15px;
        }

        .profile-name {
            font-size: 1.2em;
            font-weight: 500;
        }

        .dashboard-body {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
        }

        .info-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            transition: all 0.3s ease;
        }

        .info-section:hover {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transform: translateY(-5px);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .section-title {
            font-size: 1.3em;
            color: var(--dark-color);
            font-weight: 600;
        }

        .info-grid {
            display: grid;
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .info-value {
            font-size: 1.1em;
            color: var(--dark-color);
            padding: 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-height: 45px;
            display: flex;
            align-items: center;
        }

        .info-value.editable {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .info-value.editable:hover {
            background: #e3f2fd;
            border-color: var(--secondary-color);
        }

        .edit-input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--secondary-color);
            border-radius: 8px;
            font-size: 1em;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .copy-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #545b62;
        }

        /* System Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .setting-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #e9ecef;
        }

        .setting-card:hover {
            border-color: var(--secondary-color);
            transform: translateY(-3px);
        }

        .setting-icon {
            font-size: 2em;
            color: var(--secondary-color);
            margin-bottom: 15px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            color: var(--dark-color);
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #6c757d;
        }

        .history-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #dee2e6;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .login-body, .dashboard-body {
                padding: 20px;
            }
            
            .dashboard-header {
                flex-direction: column;
                text-align: center;
            }
            
            .method-selector {
                grid-template-columns: 1fr;
            }
            
            .settings-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading Spinner */
        .spinner {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--secondary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Status Badge */
        .status-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: var(--success-color);
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Card -->
        <div id="loginCard" class="login-card active">
            <div class="login-header">
                <div class="logo">
                    <i class="fas fa-id-card"></i>
                </div>
                <h1 class="system-title">SPIMF</h1>
                <p class="system-subtitle">Sistem Pengurusan Identiti Membership FareezOnzz</p>
                <p class="copyright">© Hak cipta dipelihara sejak 22 November 2025</p>
                
                <div class="time-info">
                    <p>Waktu Operasi Sistem Aktif: <strong>6:00 Pagi - 1:00 Pagi</strong></p>
                    <div class="countdown" id="countdownTimer">
                        ⏳ Menghitung waktu operasi sistem...
                    </div>
                </div>
            </div>
            
            <div class="login-body">
                <div class="error-message" id="loginError"></div>
                
                <div class="method-selector">
                    <div class="method-card active" data-method="phone">
                        <div class="method-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                        <h3>Kaedah 01</h3>
                        <p>PHONE NUMBER</p>
                        <small>Rujuk kolum G di spreadsheet</small>
                    </div>
                    
                    <div class="method-card" data-method="idcard">
                        <div class="method-icon">
                            <i class="fas fa-id-card"></i>
                        </div>
                        <h3>Kaedah 02</h3>
                        <p>ID CARD REGISTRATION</p>
                        <small>Rujuk kolum AB di spreadsheet</small>
                    </div>
                    
                    <div class="method-card" data-method="kode">
                        <div class="method-icon">
                            <i class="fas fa-key"></i>
                        </div>
                        <h3>Kaedah 02</h3>
                        <p>KODE USER</p>
                        <small>Rujuk kolum AC di spreadsheet</small>
                    </div>
                    
                    <div class="method-card" data-method="account">
                        <div class="method-icon">
                            <i class="fas fa-user-shield"></i>
                        </div>
                        <h3>Kaedah 03</h3>
                        <p>MEMBERSHIP ACCOUNT</p>
                        <small>Rujuk kolum AD & AE di spreadsheet</small>
                    </div>
                </div>
                
                <div class="login-form">
                    <div class="form-group">
                        <label id="methodLabel">Masukkan Nombor Telefon</label>
                        <input type="text" id="loginIdentifier" class="form-control" placeholder="Contoh: 0123456789">
                    </div>
                    
                    <div class="form-group" id="passwordGroup" style="display: none;">
                        <label>Password</label>
                        <input type="password" id="loginPassword" class="form-control" placeholder="Masukkan password">
                    </div>
                    
                    <button id="loginBtn" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> LOGIN SEKARANG
                    </button>
                    
                    <div class="spinner" id="loginSpinner"></div>
                </div>
            </div>
        </div>
        
        <!-- Dashboard -->
        <div id="dashboard" class="dashboard">
            <div class="dashboard-header">
                <div class="user-welcome">
                    <div class="welcome-text" id="welcomeMessage">
                        Hai, [Nama Pengguna]! Selamat kembali di SPIMF
                    </div>
                    <div class="admin-message" id="adminMessage">
                        Mesej dari admin akan muncul di sini...
                    </div>
                </div>
                
                <div class="profile-section">
                    <img src="" alt="Profile" class="profile-image" id="profileImage">
                    <div class="profile-name" id="profileName"></div>
                    <div class="status-badge" id="accountStatus"></div>
                </div>
            </div>
            
            <div class="dashboard-body">
                <!-- Main Member Information -->
                <div class="info-section">
                    <div class="section-header">
                        <h3 class="section-title">MAIN MEMBER INFORMATION</h3>
                        <button class="btn btn-secondary" id="editMainBtn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="info-grid" id="mainInfo"></div>
                    <div class="btn-group" id="saveMainGroup" style="display: none;">
                        <button class="btn btn-success" id="saveMainBtn">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                        <button class="btn btn-secondary" id="cancelMainBtn">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
                
                <!-- Social Media Information -->
                <div class="info-section">
                    <div class="section-header">
                        <h3 class="section-title">SOCIAL MEDIA INFORMATION</h3>
                        <button class="btn btn-secondary" id="editSocialBtn">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                    <div class="info-grid" id="socialInfo"></div>
                    <div class="btn-group" id="saveSocialGroup" style="display: none;">
                        <button class="btn btn-success" id="saveSocialBtn">
                            <i class="fas fa-save"></i> Simpan
                        </button>
                        <button class="btn btn-secondary" id="cancelSocialBtn">
                            <i class="fas fa-times"></i> Batal
                        </button>
                    </div>
                </div>
                
                <!-- Questions About You -->
                <div class="info-section">
                    <div class="section-header">
                        <h3 class="section-title">QUESTIONS ABOUT YOU</h3>
                    </div>
                    <div class="info-grid" id="questionsInfo"></div>
                </div>
                
                <!-- Additional Details -->
                <div class="info-section">
                    <div class="section-header">
                        <h3 class="section-title">YOUR ADDITIONAL DETAILS</h3>
                    </div>
                    <div class="info-grid" id="additionalInfo"></div>
                </div>
                
                <!-- System Settings -->
                <div class="info-section" style="grid-column: 1 / -1;">
                    <div class="section-header">
                        <h3 class="section-title">SYSTEM SETTINGS</h3>
                        <small style="color: #6c757d;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Jika berlaku apa-apa atas kecuaian diri sendiri tidak dapat dibantu oleh pihak SPIMF
                        </small>
                    </div>
                    
                    <div class="settings-grid">
                        <div class="setting-card" id="logCacheBtn">
                            <div class="setting-icon">
                                <i class="fas fa-clipboard-list"></i>
                            </div>
                            <h4>LOG/CACHE</h4>
                            <p>Kemaskinian setiap perubahan</p>
                        </div>
                        
                        <div class="setting-card" id="historyReturnBtn">
                            <div class="setting-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <h4>HISTORY RETURN</h4>
                            <p>Kembalikan data kepada data asal</p>
                        </div>
                        
                        <div class="setting-card" id="accountStatusBtn">
                            <div class="setting-icon">
                                <i class="fas fa-user-check"></i>
                            </div>
                            <h4>STATUS ACCOUNT</h4>
                            <p id="accountStatusText">Menyemak status...</p>
                        </div>
                        
                        <div class="setting-card" id="contactSupportBtn">
                            <div class="setting-icon">
                                <i class="fas fa-headset"></i>
                            </div>
                            <h4>HUBUNGI SOKONGAN</h4>
                            <p>Email sokongan tersedia</p>
                        </div>
                        
                        <div class="setting-card" id="logoutBtn">
                            <div class="setting-icon">
                                <i class="fas fa-sign-out-alt"></i>
                            </div>
                            <h4>LOG OUT</h4>
                            <p>Kembali ke menu login</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal for Logs -->
    <div class="modal" id="logModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Log & Cache System</h3>
                <button class="close-modal" id="closeLogModal">&times;</button>
            </div>
            <div class="history-list" id="logList"></div>
        </div>
    </div>
    
    <!-- Modal for History -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">History Return</h3>
                <button class="close-modal" id="closeHistoryModal">&times;</button>
            </div>
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>
    
    <script>
        // Global variables
        let currentSession = null;
        let userData = null;
        let isEditing = false;
        let originalData = {};
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            initLoginMethod();
            startCountdown();
            setupEventListeners();
        });
        
        // Setup event listeners
        function setupEventListeners() {
            // Login method selection
            document.querySelectorAll('.method-card').forEach(card => {
                card.addEventListener('click', function() {
                    selectLoginMethod(this.dataset.method);
                });
            });
            
            // Login button
            document.getElementById('loginBtn').addEventListener('click', handleLogin);
            
            // Enter key in login form
            document.getElementById('loginIdentifier').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            document.getElementById('loginPassword').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') handleLogin();
            });
            
            // Edit buttons
            document.getElementById('editMainBtn').addEventListener('click', () => toggleEditMode('main'));
            document.getElementById('editSocialBtn').addEventListener('click', () => toggleEditMode('social'));
            
            // Save buttons
            document.getElementById('saveMainBtn').addEventListener('click', () => saveChanges('main'));
            document.getElementById('saveSocialBtn').addEventListener('click', () => saveChanges('social'));
            
            // Cancel buttons
            document.getElementById('cancelMainBtn').addEventListener('click', () => cancelEdit('main'));
            document.getElementById('cancelSocialBtn').addEventListener('click', () => cancelEdit('social'));
            
            // System settings
            document.getElementById('logCacheBtn').addEventListener('click', showLogs);
            document.getElementById('historyReturnBtn').addEventListener('click', showHistory);
            document.getElementById('contactSupportBtn').addEventListener('click', showSupport);
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Modal close buttons
            document.getElementById('closeLogModal').addEventListener('click', () => closeModal('logModal'));
            document.getElementById('closeHistoryModal').addEventListener('click', () => closeModal('historyModal'));
            
            // Click outside modal to close
            window.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    event.target.classList.remove('active');
                }
            });
        }
        
        // Login method selection
        function initLoginMethod() {
            selectLoginMethod('phone');
        }
        
        function selectLoginMethod(method) {
            // Update UI
            document.querySelectorAll('.method-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelector(`[data-method="${method}"]`).classList.add('active');
            
            // Update form
            const identifierInput = document.getElementById('loginIdentifier');
            const passwordGroup = document.getElementById('passwordGroup');
            const methodLabel = document.getElementById('methodLabel');
            
            switch(method) {
                case 'phone':
                    methodLabel.textContent = 'Masukkan Nombor Telefon';
                    identifierInput.placeholder = 'Contoh: 0123456789';
                    passwordGroup.style.display = 'none';
                    break;
                case 'idcard':
                    methodLabel.textContent = 'Masukkan ID Card Registration';
                    identifierInput.placeholder = 'Contoh: ID-2025-001';
                    passwordGroup.style.display = 'none';
                    break;
                case 'kode':
                    methodLabel.textContent = 'Masukkan Kode User';
                    identifierInput.placeholder = 'Contoh: USER-001';
                    passwordGroup.style.display = 'none';
                    break;
                case 'account':
                    methodLabel.textContent = 'Masukkan Membership Account';
                    identifierInput.placeholder = 'Contoh: member001';
                    passwordGroup.style.display = 'block';
                    break;
            }
            
            identifierInput.focus();
        }
        
        // Handle login
        async function handleLogin() {
            const methodCards = document.querySelectorAll('.method-card.active');
            if (methodCards.length === 0) {
                showError('Sila pilih kaedah login terlebih dahulu');
                return;
            }
            
            const method = methodCards[0].dataset.method;
            const identifier = document.getElementById('loginIdentifier').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!identifier) {
                showError('Sila masukkan identitas untuk login');
                return;
            }
            
            if (method === 'account' && !password) {
                showError('Sila masukkan password untuk kaedah ini');
                return;
            }
            
            // Show loading
            document.getElementById('loginSpinner').style.display = 'block';
            document.getElementById('loginBtn').disabled = true;
            
            try {
                const response = await google.script.run
                    .withSuccessHandler(handleLoginResponse)
                    .withFailureHandler(handleLoginError)
                    .loginUser(method, identifier, password || null);
                    
                if (response.success) {
                    currentSession = response.sessionToken;
                    userData = response.userData;
                    showDashboard();
                } else {
                    showError(response.message);
                }
            } catch (error) {
                showError('Ralat sistem: ' + error.message);
            } finally {
                document.getElementById('loginSpinner').style.display = 'none';
                document.getElementById('loginBtn').disabled = false;
            }
        }
        
        function handleLoginResponse(response) {
            if (response.success) {
                currentSession = response.sessionToken;
                userData = response.userData;
                showDashboard();
            } else {
                showError(response.message);
            }
        }
        
        function handleLoginError(error) {
            showError('Ralat sistem: ' + error.message);
            document.getElementById('loginSpinner').style.display = 'none';
            document.getElementById('loginBtn').disabled = false;
        }
        
        // Show dashboard
        async function showDashboard() {
            // Hide login, show dashboard
            document.getElementById('loginCard').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
            
            // Load user data
            await loadUserData();
            
            // Update welcome message
            const name = userData['YOUR NAME / Nama anda'] || 'Pengguna';
            document.getElementById('welcomeMessage').textContent = 
                `Hai, ${name}! Selamat kembali di Sistem Pengurusan Identiti Membership FareezOnzz (SPIMF)`;
            
            // Update admin message
            const adminMessage = userData['MESSAGE ADMIN'] || 'Tiada mesej dari admin';
            document.getElementById('adminMessage').textContent = adminMessage;
            
            // Update profile
            document.getElementById('profileName').textContent = name;
            
            // Update profile image
            const imageUrl = userData['Profile Membership Format Dari Google Drive Link'];
            if (imageUrl && imageUrl.includes('drive.google.com')) {
                // Convert Google Drive link to direct image link
                const fileId = imageUrl.match(/\/d\/(.+?)\//)?.[1] || 
                              imageUrl.match(/id=(.+?)(&|$)/)?.[1];
                if (fileId) {
                    document.getElementById('profileImage').src = 
                        `https://drive.google.com/uc?export=view&id=${fileId}`;
                }
            }
            
            // Update account status
            const status = userData['STATUS ACCOUNT'];
            const statusBadge = document.getElementById('accountStatus');
            const statusText = document.getElementById('accountStatusText');
            
            if (status && status.includes('✅AKTIF')) {
                statusBadge.className = 'status-badge status-active';
                statusBadge.textContent = '✅ AKTIF';
                statusText.textContent = '✅ AKTIF';
                enableEditing();
            } else {
                statusBadge.className = 'status-badge status-inactive';
                statusBadge.textContent = '❌ TIDAK AKTIF';
                statusText.textContent = '❌ TIDAK AKTIF';
                disableEditing();
            }
            
            // Render information sections
            renderMainInfo();
            renderSocialInfo();
            renderQuestionsInfo();
            renderAdditionalInfo();
        }
        
        // Load user data
        async function loadUserData() {
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            userData = response.userData;
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error loading user data:', error);
                    })
                    .getUserData(currentSession, userData.rowNumber);
            } catch (error) {
                console.error('Error:', error);
            }
        }
        
        // Render information sections
        function renderMainInfo() {
            const fields = [
                { key: 'YOUR NAME / Nama anda', label: 'Nama Anda' },
                { key: 'YOUR AGE / Umur anda', label: 'Umur Anda' },
                { key: 'YOUR DATE OF BIRTH / Tarikh lahir anda', label: 'Tarikh Lahir' },
                { key: 'GENDER : MALE / FEMALE', label: 'Jantina' },
                { key: 'YOUR RELIGION / Agama anda', label: 'Agama' },
                { key: 'YOUR COUNTRY / Negara anda', label: 'Negara' },
                { key: 'YOUR STATE : DISTRICT/CITY', label: 'Negeri/Daerah' },
                { key: 'PHONE NUMBER / Nombor telefon', label: 'Nombor Telefon' },
                { key: 'ARE YOU LEFT-HANDED "WRITING WITH LEFT HAND"', label: 'Tangan Kidal' },
                { key: 'WHAT IS YOUR DREAM CAREER "YOUR ASPIRATION"', label: 'Kerjaya Impian' },
                { key: 'EMAIL ADDRESS', label: 'Email' }
            ];
            
            const container = document.getElementById('mainInfo');
            container.innerHTML = '';
            
            fields.forEach(field => {
                const value = userData[field.key] || '-';
                const div = document.createElement('div');
                div.className = 'info-item';
                div.innerHTML = `
                    <div class="info-label">${field.label}</div>
                    <div class="info-value editable" data-field="${field.key}">${value}</div>
                `;
                container.appendChild(div);
            });
            
            // Store original values
            fields.forEach(field => {
                originalData[field.key] = userData[field.key] || '';
            });
        }
        
        function renderSocialInfo() {
            const hasSocial = userData['DO YOU HAVE A SOCIAL MEDIA ACCOUNT AND HAVE MORE THAN 50 FOLLOWERS'];
            const container = document.getElementById('socialInfo');
            container.innerHTML = '';
            
            // Always show the first question
            const firstDiv = document.createElement('div');
            firstDiv.className = 'info-item';
            firstDiv.innerHTML = `
                <div class="info-label">Ada Akaun Media Sosial?</div>
                <div class="info-value editable" data-field="DO YOU HAVE A SOCIAL MEDIA ACCOUNT AND HAVE MORE THAN 50 FOLLOWERS">
                    ${hasSocial || '-'}
                </div>
            `;
            container.appendChild(firstDiv);
            
            // Only show social media fields if answer is "Ada"
            if (hasSocial && hasSocial.toLowerCase().includes('ada')) {
                const socialFields = [
                    { key: 'TIKTOK', label: 'TikTok' },
                    { key: 'INSTAGRAM', label: 'Instagram' },
                    { key: 'YOUTUBE', label: 'YouTube' },
                    { key: ' TWITTER', label: 'Twitter' }
                ];
                
                socialFields.forEach(field => {
                    const value = userData[field.key] || '-';
                    const div = document.createElement('div');
                    div.className = 'info-item';
                    div.innerHTML = `
                        <div class="info-label">${field.label}</div>
                        <div class="info-value editable" data-field="${field.key}">${value}</div>
                    `;
                    container.appendChild(div);
                    
                    // Store original value
                    originalData[field.key] = userData[field.key] || '';
                });
            }
            
            // Store original value for first field
            originalData['DO YOU HAVE A SOCIAL MEDIA ACCOUNT AND HAVE MORE THAN 50 FOLLOWERS'] = hasSocial || '';
        }
        
        function renderQuestionsInfo() {
            const fields = [
                { key: 'DO YOU LIKE TO REPAIR / Adakah anda suka membaiki', label: 'Suka Membaiki?' },
                { key: 'YOUR FAVORITE SUBJECT / Subjek kegemaran anda', label: 'Subjek Kegemaran' },
                { key: 'THE SUBJECT YOU FIND MOST DIFFICULT', label: 'Subjek Paling Sukar' }
            ];
            
            const container = document.getElementById('questionsInfo');
            container.innerHTML = '';
            
            fields.forEach(field => {
                const value = userData[field.key] || '-';
                const div = document.createElement('div');
                div.className = 'info-item';
                div.innerHTML = `
                    <div class="info-label">${field.label}</div>
                    <div class="info-value">${value}</div>
                `;
                container.appendChild(div);
            });
        }
        
        function renderAdditionalInfo() {
            const fields = [
                { key: 'YOU KNOW US AS / Anda mengenali kami sebagai', label: 'Mengenal Kami Sebagai' },
                { key: 'CURRENT DATE / Tarikh semasa', label: 'Tarikh Daftar' },
                { key: 'SCORE', label: 'Skor' },
                { key: 'ID CARD REGISTRATION', label: 'ID Card Registration', copy: true },
                { key: 'KODE USER', label: 'Kode User', copy: true },
                { key: 'MEMBERSHIP ACCOUNT', label: 'Membership Account', copy: true },
                { key: 'MEMBERSHIP PASSWORD ACCOUNT', label: 'Membership Password', copy: true }
            ];
            
            const container = document.getElementById('additionalInfo');
            container.innerHTML = '';
            
            fields.forEach(field => {
                const value = userData[field.key] || '-';
                const div = document.createElement('div');
                div.className = 'info-item';
                
                let valueHTML = `<div class="info-value">${value}</div>`;
                
                if (field.copy && value !== '-') {
                    valueHTML = `
                        <div class="info-value" style="display: flex; justify-content: space-between; align-items: center;">
                            <span>${value}</span>
                            <button class="copy-btn" data-text="${value}">
                                <i class="fas fa-copy"></i> Salin
                            </button>
                        </div>
                    `;
                }
                
                div.innerHTML = `
                    <div class="info-label">${field.label}</div>
                    ${valueHTML}
                `;
                container.appendChild(div);
            });
            
            // Add copy functionality
            container.querySelectorAll('.copy-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const text = this.dataset.text;
                    copyToClipboard(text);
                });
            });
        }
        
        // Toggle edit mode
        function toggleEditMode(section) {
            if (isEditing) {
                showToast('Sila selesaikan edit semasa dahulu', 'warning');
                return;
            }
            
            isEditing = true;
            const container = document.getElementById(section === 'main' ? 'mainInfo' : 'socialInfo');
            const saveGroup = document.getElementById(section === 'main' ? 'saveMainGroup' : 'saveSocialGroup');
            const editBtn = document.getElementById(section === 'main' ? 'editMainBtn' : 'editSocialBtn');
            
            // Convert editable fields to inputs
            container.querySelectorAll('.info-value.editable').forEach(div => {
                const field = div.dataset.field;
                const currentValue = div.textContent.trim();
                
                let inputHTML = '';
                
                // Special handling for gender field
                if (field === 'GENDER : MALE / FEMALE') {
                    inputHTML = `
                        <select class="edit-input" data-field="${field}">
                            <option value="MALE / LELAKI" ${currentValue === 'MALE / LELAKI' ? 'selected' : ''}>LELAKI</option>
                            <option value="FEMALE / PEREMPUAN" ${currentValue === 'FEMALE / PEREMPUAN' ? 'selected' : ''}>PEREMPUAN</option>
                        </select>
                    `;
                } 
                // Special handling for yes/no fields
                else if (field === 'ARE YOU LEFT-HANDED "WRITING WITH LEFT HAND"' || 
                         field === 'DO YOU HAVE A SOCIAL MEDIA ACCOUNT AND HAVE MORE THAN 50 FOLLOWERS') {
                    inputHTML = `
                        <select class="edit-input" data-field="${field}">
                            <option value="YA / YES" ${currentValue === 'YA / YES' ? 'selected' : ''}>YA</option>
                            <option value="TIDAK / NO" ${currentValue === 'TIDAK / NO' ? 'selected' : ''}>TIDAK</option>
                            <option value="ADA" ${currentValue === 'ADA' ? 'selected' : ''}>ADA</option>
                            <option value="TIADA" ${currentValue === 'TIADA' ? 'selected' : ''}>TIADA</option>
                        </select>
                    `;
                }
                else {
                    inputHTML = `<input type="text" class="edit-input" data-field="${field}" value="${currentValue}">`;
                }
                
                div.innerHTML = inputHTML;
            });
            
            // Show save buttons
            saveGroup.style.display = 'flex';
            editBtn.style.display = 'none';
            
            // Focus first input
            const firstInput = container.querySelector('.edit-input');
            if (firstInput) firstInput.focus();
        }
        
        // Save changes
        async function saveChanges(section) {
            const container = document.getElementById(section === 'main' ? 'mainInfo' : 'socialInfo');
            const inputs = container.querySelectorAll('.edit-input');
            
            const updates = {};
            inputs.forEach(input => {
                updates[input.dataset.field] = input.value.trim();
            });
            
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showToast('Data berjaya dikemaskini!', 'success');
                            
                            // Update userData with new values
                            Object.keys(updates).forEach(key => {
                                userData[key] = updates[key];
                            });
                            
                            // Exit edit mode
                            cancelEdit(section);
                            isEditing = false;
                            
                            // Re-render sections
                            if (section === 'main') {
                                renderMainInfo();
                            } else {
                                renderSocialInfo();
                            }
                            
                            // Update welcome message if name changed
                            if (updates['YOUR NAME / Nama anda']) {
                                document.getElementById('welcomeMessage').textContent = 
                                    `Hai, ${updates['YOUR NAME / Nama anda']}! Selamat kembali di SPIMF`;
                                document.getElementById('profileName').textContent = updates['YOUR NAME / Nama anda'];
                            }
                        } else {
                            showToast(response.message, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('Ralat: ' + error.message, 'error');
                    })
                    .updateUserData(currentSession, updates, userData.rowNumber);
                    
            } catch (error) {
                showToast('Ralat sistem: ' + error.message, 'error');
            }
        }
        
        // Cancel edit
        function cancelEdit(section) {
            isEditing = false;
            const container = document.getElementById(section === 'main' ? 'mainInfo' : 'socialInfo');
            const saveGroup = document.getElementById(section === 'main' ? 'saveMainGroup' : 'saveSocialGroup');
            const editBtn = document.getElementById(section === 'main' ? 'editMainBtn' : 'editSocialBtn');
            
            // Restore original display
            if (section === 'main') {
                renderMainInfo();
            } else {
                renderSocialInfo();
            }
            
            // Hide save buttons, show edit button
            saveGroup.style.display = 'none';
            editBtn.style.display = 'block';
        }
        
        // Enable/disable editing based on account status
        function enableEditing() {
            document.getElementById('editMainBtn').disabled = false;
            document.getElementById('editSocialBtn').disabled = false;
        }
        
        function disableEditing() {
            document.getElementById('editMainBtn').disabled = true;
            document.getElementById('editSocialBtn').disabled = true;
            showToast('Akun tidak aktif. Edit tidak dibenarkan.', 'warning');
        }
        
        // System settings functions
        async function showLogs() {
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(history) {
                        const container = document.getElementById('logList');
                        container.innerHTML = '';
                        
                        if (history.length === 0) {
                            container.innerHTML = '<p style="text-align: center; color: #6c757d;">Tiada log ditemukan</p>';
                        } else {
                            history.forEach((log, index) => {
                                const div = document.createElement('div');
                                div.className = 'history-item';
                                div.innerHTML = `
                                    <strong>${new Date(log.timestamp).toLocaleString()}</strong><br>
                                    <small>${log.field}: ${log.oldValue} → ${log.newValue}</small>
                                `;
                                container.appendChild(div);
                            });
                        }
                        
                        document.getElementById('logModal').classList.add('active');
                    })
                    .withFailureHandler(function(error) {
                        showToast('Ralat memuat log: ' + error.message, 'error');
                    })
                    .getUpdateHistory(userData.rowNumber);
                    
            } catch (error) {
                showToast('Ralat: ' + error.message, 'error');
            }
        }
        
        async function showHistory() {
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(history) {
                        const container = document.getElementById('historyList');
                        container.innerHTML = '';
                        
                        if (history.length === 0) {
                            container.innerHTML = '<p style="text-align: center; color: #6c757d;">Tiada history ditemukan</p>';
                        } else {
                            history.forEach((log, index) => {
                                const div = document.createElement('div');
                                div.className = 'history-item';
                                div.innerHTML = `
                                    <strong>${new Date(log.timestamp).toLocaleString()}</strong><br>
                                    <small>${log.field}: ${log.oldValue} → ${log.newValue}</small>
                                    <button class="btn btn-secondary" style="margin-top: 5px; width: 100%;" 
                                            onclick="revertChange(${index})">
                                        <i class="fas fa-undo"></i> Kembalikan
                                    </button>
                                `;
                                container.appendChild(div);
                            });
                        }
                        
                        document.getElementById('historyModal').classList.add('active');
                    })
                    .withFailureHandler(function(error) {
                        showToast('Ralat memuat history: ' + error.message, 'error');
                    })
                    .getUpdateHistory(userData.rowNumber);
                    
            } catch (error) {
                showToast('Ralat: ' + error.message, 'error');
            }
        }
        
        async function revertChange(logIndex) {
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(response) {
                        if (response.success) {
                            showToast('Data berjaya dikembalikan!', 'success');
                            closeModal('historyModal');
                            loadUserData().then(() => {
                                renderMainInfo();
                                renderSocialInfo();
                            });
                        } else {
                            showToast(response.message, 'error');
                        }
                    })
                    .withFailureHandler(function(error) {
                        showToast('Ralat: ' + error.message, 'error');
                    })
                    .revertChanges(userData.rowNumber, logIndex);
                    
            } catch (error) {
                showToast('Ralat sistem: ' + error.message, 'error');
            }
        }
        
        function showSupport() {
            showToast(
                'Hubungi sokongan:<br>pfareezonzz01@gmail.com<br>developerfareezonzz@gmail.com',
                'info',
                5000
            );
        }
        
        // Logout
        async function handleLogout() {
            if (confirm('Adakah anda pasti ingin log keluar?')) {
                try {
                    await google.script.run
                        .withSuccessHandler(function() {
                            // Reset everything
                            currentSession = null;
                            userData = null;
                            isEditing = false;
                            originalData = {};
                            
                            // Show login, hide dashboard
                            document.getElementById('dashboard').classList.remove('active');
                            document.getElementById('loginCard').classList.add('active');
                            
                            // Reset login form
                            document.getElementById('loginIdentifier').value = '';
                            document.getElementById('loginPassword').value = '';
                            document.getElementById('loginError').style.display = 'none';
                            selectLoginMethod('phone');
                            
                            showToast('Logout berjaya!', 'success');
                        })
                        .withFailureHandler(function(error) {
                            showToast('Ralat logout: ' + error.message, 'error');
                        })
                        .logoutUser(currentSession);
                        
                } catch (error) {
                    showToast('Ralat sistem: ' + error.message, 'error');
                }
            }
        }
        
        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'success' ? '#27ae60' : 
                                   type === 'error' ? '#e74c3c' : 
                                   type === 'warning' ? '#f39c12' : '#3498db';
            toast.style.display = 'block';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, duration);
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        async function copyToClipboard(text) {
            try {
                await navigator.clipboard.writeText(text);
                showToast('Berjaya disalin ke clipboard!', 'success');
            } catch (err) {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('Berjaya disalin ke clipboard!', 'success');
            }
        }
        
        // Countdown timer
        function startCountdown() {
            updateCountdown();
            setInterval(updateCountdown, 1000);
        }
        
        async function updateCountdown() {
            try {
                const response = await google.script.run
                    .withSuccessHandler(function(data) {
                        const timer = document.getElementById('countdownTimer');
                        if (data.isOperational) {
                            timer.innerHTML = `⏳ Sistem Aktif: ${data.hours}:${data.minutes}:${data.seconds} ke 1:00`;
                            timer.style.color = '#27ae60';
                        } else {
                            timer.innerHTML = `⏳ Sistem Tidak Aktif: ${data.hours}:${data.minutes}:${data.seconds} ke 6:00`;
                            timer.style.color = '#e74c3c';
                        }
                    })
                    .withFailureHandler(function(error) {
                        console.error('Countdown error:', error);
                    })
                    .getCountdown();
                    
            } catch (error) {
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>
